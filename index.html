<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Var Group - Prepara un Incontro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <style>
        .generating {
            background: linear-gradient(90deg, #e5e7eb, #f3f4f6, #e5e7eb);
            background-size: 200% 100%;
            animation: loading 2s ease-in-out infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .step-transition {
            transition: all 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center mr-4">
                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Var Group - Prepara un Incontro</h1>
                    <p class="text-gray-600 text-sm">Il tuo wizard strategico per preparazioni vincenti</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Indicator -->
    <div id="stepIndicator" class="w-full px-8 py-6 bg-white border-b">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-start justify-between">
                <!-- Steps will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md p-8">
            <div id="stepContent">
                <!-- Step content will be injected here -->
            </div>
            
            <!-- Navigation -->
            <div class="flex justify-between mt-8 pt-6 border-t">
                <button id="prevBtn" class="inline-flex items-center px-5 py-2.5 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
                    <span id="prevBtnText">Homepage</span>
                </button>
                <div class="flex gap-3">
                    <button id="nextBtn" class="inline-flex items-center px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-colors">
                        <span id="nextBtnText">Prosegui con la Preparazione</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 ml-1"></i>
                    </button>
                    <button id="summaryBtn" class="hidden inline-flex items-center px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Visualizza Riepilogo
                        <i data-lucide="file-text" class="w-5 h-5 ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Success Modal -->
    <div id="copyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
                <p class="text-gray-800 font-semibold">Contenuto copiato!</p>
                <p class="text-gray-600 text-sm mt-2">Il testo è stato copiato negli appunti</p>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
<div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Errore di Generazione</h3>
            <p id="errorMessage" class="text-gray-600 text-sm mb-4"></p>
            <button onclick="closeErrorModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Chiudi
            </button>
        </div>
    </div>
</div>

    <script>
        // Configuration - SOSTITUIRE CON LA PROPRIA API KEY GOOGLE GEMINI
        const API_KEY = "AIzaSyCwtjsNaWLh28_bXrHJOHaMgzFDVjOHXiQ";
        
        // Application State
        let currentStep = 0;
        let isGenerating = false;
        let generatedPrompt = '';
        
        const appData = {
            // Pre-research data
            preResearch: {
                prospectName: '',
                contactPerson: '',
                areasOfInterest: '',
                ourCompanyInfo: { content: '', names: [] }
            },
            // Main wizard data
            companyName: '',
            serviceName: '',
            clientFiles: { content: '', names: [] },
            internalFiles: { content: '', names: [] },
            cswotAnalysis: '',
            valueAreas: '',
            onePager: '',
            contactEmail: '',
            discoveryQuestions: '',
            finalBriefing: '',
            challengerMode: false
        };

        // Var Group Context (abbreviato per GitHub - versione completa da mantenere)
        const VAR_GROUP_CONTEXT = `
# Var Group - Digital Soul Company

## Identità e Missione
Var Group è il pilastro strategico del Gruppo SeSa dedicato alla System Integration e alle soluzioni digitali per le imprese. Con oltre 4.297 dipendenti e 882 milioni di euro di fatturato previsto per il 2025, rappresentiamo un partner strategico per la trasformazione digitale delle aziende clienti.

### Visione "Digital Soul"
La nostra visione è promuovere un futuro in cui il mondo digitale e il business si integrano armonicamente, attraverso la condivisione profonda di conoscenze ed esperienze abilitata dal digitale.

## Business Unit Principali

### 7Circle - Digital Evolution
Guida le aziende nella loro evoluzione digitale con focus su Cloud, servitizzazione e valorizzazione dei dati.

### Data Science - Data-Driven Intelligence  
Centro di competenza con oltre 180 risorse e 40+ Data Scientist specializzato in AI, Machine Learning e Advanced Analytics.

### Yarix - Digital Security
Divisione cybersecurity con oltre 230 specialisti e 3 SOC che analizzano 500.000 eventi al secondo.

### Var Industries - Digital Engineering
Soluzioni per progettazione, simulazione e produzione nel manifatturiero, con presenza in 13 nazioni.

### Enterprise Platform - Business Applications
Competenze SAP e Microsoft con oltre 500 consulenti e fatturato di 75+ milioni di euro.

### Digital Experience (Ubics) - Customer Engagement
Digital Experience Agency per siti web, portali, app mobile ed e-commerce.

### Multimedia & Workspaces - Hybrid Collaboration
Progettazione di spazi di lavoro ibridi e soluzioni di comunicazione avanzate.

## Iniziativa Strategica iSquared
Nuova iniziativa per guidare le aziende oltre il "Paradosso Adozione-Valore" dell'AI, basata sulla "Regola 10-20-70" dove il 70% del successo dipende da persone, processi e cambiamento organizzativo.

## Partnership Strategiche
Microsoft (Gold Partner), SAP (Platinum Partner), AWS, IBM, HPE, Cisco, Oracle, Siemens, Google Cloud e altri leader tecnologici.

## Settori di Competenza
Manufacturing, Fashion & Luxury, Retail & GDO, Food & Beverage, Pharma & Chemical, Servizi Finanziari, Pubblica Amministrazione.
`;

        // Step configuration
        const stepsConfig = [
            { id: 0, name: 'Ricerca Prospect', icon: 'search' },
            { id: 1, name: 'Input Iniziali', icon: 'file-text' },
            { id: 2, name: 'Analisi C-SWOT', icon: 'target' },
            { id: 3, name: 'Aree di Valore', icon: 'users' },
            { id: 4, name: 'One-Pager', icon: 'file-question' },
            { id: 5, name: 'Domande Discovery', icon: 'target' },
            { id: 6, name: 'Briefing Finale', icon: 'briefcase' }
        ];

        // Initialize PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
        }

        // Utility Functions
        function updateStepIndicator() {
            const indicatorContainer = document.querySelector('#stepIndicator .max-w-6xl > div');
            indicatorContainer.innerHTML = '';
            
            stepsConfig.forEach((step, index) => {
                const isActive = index <= currentStep;
                const isCurrent = index === currentStep;
                
                // Step circle
                const stepDiv = document.createElement('div');
                stepDiv.className = 'flex flex-col items-center step-transition';
                
                const circleDiv = document.createElement('div');
                circleDiv.className = `w-12 h-12 rounded-full flex items-center justify-center ${
                    isActive ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'
                } ${isCurrent ? 'transform scale-110' : ''}`;
                
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', step.icon);
                icon.className = 'w-6 h-6';
                circleDiv.appendChild(icon);
                
                const nameSpan = document.createElement('span');
                nameSpan.className = `mt-2 text-xs font-medium text-center max-w-20 ${
                    isActive ? 'text-indigo-600' : 'text-gray-500'
                }`;
                nameSpan.textContent = step.name;
                
                stepDiv.appendChild(circleDiv);
                stepDiv.appendChild(nameSpan);
                indicatorContainer.appendChild(stepDiv);
                
                // Progress line (except for last step)
                if (index < stepsConfig.length - 1) {
                    const progressLine = document.createElement('div');
                    progressLine.className = 'flex-1 h-0.5 mx-2 bg-gray-200 rounded-full overflow-hidden';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'h-full bg-indigo-600 step-transition';
                    progressFill.style.width = currentStep > index ? '100%' : '0%';
                    
                    progressLine.appendChild(progressFill);
                    indicatorContainer.appendChild(progressLine);
                }
            });
            
            lucide.createIcons();
        }

        async function generateContent(prompt, isJson = false) {
    const modelName = "gemini-1.5-pro";  // Cambia da "gemini-2.5-pro" a "gemini-1.5-pro"
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

    const requestBody = {
        contents: [{ 
            role: "user", 
            parts: [{ text: prompt }] 
        }],
        generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 8192,
            ...(isJson && { responseMimeType: "application/json" })
        },
        safetySettings: [
            {
                category: "HARM_CATEGORY_HARASSMENT",
                threshold: "BLOCK_NONE"
            },
            {
                category: "HARM_CATEGORY_HATE_SPEECH", 
                threshold: "BLOCK_NONE"
            },
            {
                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                threshold: "BLOCK_NONE"
            },
            {
                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                threshold: "BLOCK_NONE"
            }
        ]
    };

    try {
        console.log("Invio richiesta API:", { modelName, promptLength: prompt.length });
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'User-Agent': 'VarGroupWizard/1.0'
            },
            body: JSON.stringify(requestBody),
        });
        
        console.log("Status risposta:", response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Errore API completo:", errorText);
            throw new Error(`API Error (${response.status}): ${errorText}`);
        }

        const result = await response.json();
        console.log("Risposta API ricevuta:", result);
        
        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
            let rawText = result.candidates[0].content.parts[0].text;
            return rawText.replace(/^\s*```(json|html|markdown)?\n?/, '').replace(/\n?```\s*$/, '');
        } else {
            console.error("Struttura risposta non valida:", result);
            throw new Error("Formato risposta AI non valido");
        }
    } catch (error) {
        console.error("Errore nella chiamata API:", error);
        throw error;
    }
}

        async function parseFile(file) {
            try {
                if (file.type.includes('text') || file.name.endsWith('.md')) {
                    return await file.text();
                } else if (file.type.includes('wordprocessingml') || file.name.endsWith('.docx')) {
                    if (!window.mammoth) throw new Error('Libreria DOCX non disponibile');
                    const result = await window.mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                    return result.value;
                } else if (file.type === 'application/pdf') {
                    if (!window.pdfjsLib) throw new Error('Libreria PDF non disponibile');
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let pdfText = '';
                    for (let i = 0; i < pdf.numPages; i++) {
                        const page = await pdf.getPage(i + 1);
                        const textContent = await page.getTextContent();
                        pdfText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    return pdfText;
                }
                throw new Error(`Formato file non supportato: ${file.name}`);
            } catch (error) {
                console.error("Errore parsing file:", error);
                alert(`Errore nel caricamento del file ${file.name}: ${error.message}`);
                return null;
            }
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyModal();
                } else {
                    alert('Impossibile copiare il testo');
                }
            } catch (err) {
                console.error('Errore copia:', err);
                alert('Errore durante la copia');
            }

            document.body.removeChild(textArea);
        }

        function showCopyModal() {
            const modal = document.getElementById('copyModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 2000);
        }
        function showErrorModal(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').classList.remove('hidden');
}

function closeErrorModal() {
    document.getElementById('errorModal').classList.add('hidden');
}

        function createCopyButton(text, label = 'Copia') {
            return `<button onclick="copyToClipboard(\`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                      class="inline-flex items-center px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-300 transition-colors">
                        <i data-lucide="copy" class="w-4 h-4 mr-1.5"></i>
                        ${label}
                    </button>`;
        }

        // Event Handlers
        function updateField(field, value) {
            appData[field] = value;
        }

        function updateFileContent(fileType, property, value) {
            appData[fileType][property] = value;
        }

        function updatePreResearchField(field, value) {
            appData.preResearch[field] = value;
        }

        async function handleFileUpload(event, fileType) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const progressEl = event.target.parentElement.querySelector('.upload-progress');
            if (progressEl) progressEl.classList.remove('hidden');

            let combinedContent = appData[fileType].content;
            const newNames = [...appData[fileType].names];

            for (const file of files) {
                const content = await parseFile(file);
                if (content !== null) {
                    combinedContent += `\n\n--- INIZIO FILE: ${file.name} ---\n${content}\n--- FINE FILE: ${file.name} ---\n`;
                    newNames.push(file.name);
                }
            }

            appData[fileType] = { content: combinedContent, names: newNames };
            
            if (progressEl) progressEl.classList.add('hidden');
            renderCurrentStep();
        }

        async function handlePreResearchFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            let combinedContent = appData.preResearch.ourCompanyInfo.content;
            const newNames = [...appData.preResearch.ourCompanyInfo.names];

            for (const file of files) {
                const content = await parseFile(file);
                if (content !== null) {
                    combinedContent += `\n\n--- INIZIO FILE: ${file.name} ---\n${content}\n--- FINE FILE: ${file.name} ---\n`;
                    newNames.push(file.name);
                }
            }

            appData.preResearch.ourCompanyInfo = { content: combinedContent, names: newNames };
            renderCurrentStep();
        }

        function canGeneratePrompt() {
            return appData.preResearch.prospectName.trim() && appData.preResearch.ourCompanyInfo.content.trim();
        }

        function canProceed() {
            switch (currentStep) {
                case 0: return true;
                case 1: return appData.companyName.trim() && appData.serviceName.trim();
                case 2: return appData.cswotAnalysis.trim();
                case 3: return appData.valueAreas.trim();
                case 4: return appData.onePager.trim();
                case 5: return appData.discoveryQuestions.trim();
                case 6: return appData.finalBriefing.trim();
                default: return false;
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const summaryBtn = document.getElementById('summaryBtn');
            const prevBtnText = document.getElementById('prevBtnText');
            const nextBtnText = document.getElementById('nextBtnText');

            // Previous button
            prevBtnText.textContent = currentStep === 0 ? 'Homepage' : 'Indietro';
            prevBtn.disabled = isGenerating;

            // Next/Summary button logic
            if (currentStep < 6) {
                nextBtn.classList.remove('hidden');
                summaryBtn.classList.add('hidden');
                nextBtn.disabled = !canProceed() || isGenerating;
                nextBtnText.textContent = currentStep === 0 ? 'Prosegui con la Preparazione' : 'Avanti';
            } else {
                nextBtn.classList.add('hidden');
                if (appData.finalBriefing.trim()) {
                    summaryBtn.classList.remove('hidden');
                }
            }
        }

        // Step Rendering Functions
        function renderGeneratingPlaceholder(text = "L'AI sta lavorando per te...") {
            return `
                <div class="w-full min-h-[15rem] flex flex-col items-center justify-center bg-gray-500/10 rounded-lg p-8 text-center border border-gray-200 generating">
                    <i data-lucide="loader-2" class="w-10 h-10 text-indigo-500 mb-4 animate-spin"></i>
                    <p class="text-lg font-medium text-gray-700">${text}</p>
                    <p class="text-sm text-gray-500 mt-1">Questa operazione potrebbe richiedere qualche istante.</p>
                </div>
            `;
        }

        function renderStep0() {
            return `
                <div class="space-y-8">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Step 0: Ricerca Prospect (Opzionale)</h2>
                            <p class="text-gray-600 mt-1">L'AI analizza i tuoi dati e genera un prompt di ricerca personalizzato.</p>
                        </div>
                        <button onclick="proceedToStep1()" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
                            Salta alla preparazione <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                        </button>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Azienda Prospect</label>
                                <input type="text" id="prospectName" value="${appData.preResearch.prospectName}" 
                                       oninput="updatePreResearchField('prospectName', this.value); updatePromptButton();"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                       placeholder="Es. FuturaTech S.p.A." />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome e Ruolo Contatto <span class="text-gray-500">(Opzionale)</span></label>
                                <input type="text" id="contactPerson" value="${appData.preResearch.contactPerson}" 
                                       oninput="updatePreResearchField('contactPerson', this.value)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                       placeholder="Es. Laura Verdi, Head of Innovation" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Aree di Interesse <span class="text-gray-500">(Opzionale)</span></label>
                                <textarea id="areasOfInterest" oninput="updatePreResearchField('areasOfInterest', this.value)" 
                                          rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                          placeholder="Es. Ottimizzazione supply chain, digitalizzazione...">${appData.preResearch.areasOfInterest}</textarea>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">File Offerta/Competenze</label>
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-100">
                                    <i data-lucide="upload" class="w-8 h-8 text-gray-400 mb-2"></i>
                                    <span class="text-sm text-gray-600">Carica file (.txt, .md, .docx, .pdf)</span>
                                    <input type="file" multiple class="hidden" accept=".txt,.md,.docx,.pdf" onchange="handlePreResearchFileUpload(event)" />
                                </label>
                                ${appData.preResearch.ourCompanyInfo.names.length > 0 ? `
                                    <div class="mt-2 text-sm text-green-600">
                                        <p class="font-semibold">File caricati:</p>
                                        <ul class="list-disc list-inside ml-4">
                                            ${appData.preResearch.ourCompanyInfo.names.map(name => `<li>${name}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <button id="generatePromptBtn" onclick="generateResearchPrompt()" 
                            class="w-full px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            ${!canGeneratePrompt() ? 'disabled' : ''}>
                        <i data-lucide="search" class="w-5 h-5 mr-2 inline"></i>
                        <span id="generatePromptBtnText">Genera Prompt di Ricerca AI</span>
                    </button>

                    <div id="promptResult" class="space-y-4 p-6 border rounded-lg ${generatedPrompt ? '' : 'hidden'}">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-lg text-gray-700">Prompt di Ricerca Generato</h3>
                            <div id="promptCopyBtn"></div>
                        </div>
                        <div class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto">
                            <div id="promptContent">${generatedPrompt}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 1: Input Iniziali</h2>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Azienda Cliente</label>
                            <input type="text" id="companyName" value="${appData.companyName}" 
                                   oninput="updateField('companyName', this.value); updateNavigation();"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                   placeholder="Es. Acme Corporation" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Servizio/Soluzione da Presentare</label>
                            <input type="text" id="serviceName" value="${appData.serviceName}" 
                                   oninput="updateField('serviceName', this.value); updateNavigation();"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                   placeholder="Es. Digital Transformation Suite" />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Informazioni Cliente</label>
                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <i data-lucide="upload" class="w-10 h-10 text-gray-400 mb-2"></i>
                            <span class="text-sm text-gray-600">File informazioni cliente</span>
                            <input type="file" multiple class="hidden" accept=".txt,.md,.docx,.pdf" onchange="handleFileUpload(event, 'clientFiles')" />
                        </label>
                        ${appData.clientFiles.names.length > 0 ? `
                            <div class="mt-2 text-sm text-green-600">
                                <p class="font-semibold">File caricati:</p>
                                <ul class="list-disc list-inside ml-4">
                                    ${appData.clientFiles.names.map(name => `<li>${name}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <textarea id="clientContent" oninput="updateFileContent('clientFiles', 'content', this.value)"
                                  rows="4" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                  placeholder="Oppure incolla qui le informazioni sul cliente...">${appData.clientFiles.content}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Informazioni Nostra Offerta</label>
                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <i data-lucide="upload" class="w-10 h-10 text-gray-400 mb-2"></i>
                            <span class="text-sm text-gray-600">File nostra offerta</span>
                            <input type="file" multiple class="hidden" accept=".txt,.md,.docx,.pdf" onchange="handleFileUpload(event, 'internalFiles')" />
                        </label>
                        ${appData.internalFiles.names.length > 0 ? `
                            <div class="mt-2 text-sm text-green-600">
                                <p class="font-semibold">File caricati:</p>
                                <ul class="list-disc list-inside ml-4">
                                    ${appData.internalFiles.names.map(name => `<li>${name}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <textarea id="internalContent" oninput="updateFileContent('internalFiles', 'content', this.value)"
                                  rows="4" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                  placeholder="Oppure incolla qui le informazioni sulla tua offerta...">${appData.internalFiles.content}</textarea>
                    </div>
                </div>
            `;
        }

        function renderStep2() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 2: Analisi C-SWOT del Cliente</h2>
                    
                    ${isGenerating ? renderGeneratingPlaceholder("Analisi C-SWOT in corso...") : 
                      !appData.cswotAnalysis ? `
                        <div class="text-center py-12">
                            <i data-lucide="target" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Genera un'analisi C-SWOT strategica basata sui dati inseriti</p>
                            <button onclick="generateCSWOT()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                <i data-lucide="target" class="w-5 h-5 mr-2"></i>Genera Analisi C-SWOT
                            </button>
                        </div>
                      ` : `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">Analisi C-SWOT</h3>
                                    ${createCopyButton(appData.cswotAnalysis)}
                                </div>
                                <div class="prose prose-sm max-w-none p-4 bg-gray-50 rounded border min-h-[300px] whitespace-pre-wrap">${appData.cswotAnalysis}</div>
                            </div>
                            <button onclick="generateCSWOT()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                Rigenera Analisi
                            </button>
                        </div>
                      `
                    }
                </div>
            `;
        }

        function renderStep3() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 3: Mappatura Aree di Valore</h2>
                    
                    ${isGenerating ? renderGeneratingPlaceholder("Mappatura Aree di Valore in corso...") : 
                      !appData.valueAreas ? `
                        <div class="text-center py-12">
                            <i data-lucide="users" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Identifica le aree dove Var Group può portare valore al cliente</p>
                            <button onclick="generateValueAreas()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">
                                <i data-lucide="users" class="w-5 h-5 mr-2"></i>Genera Aree di Valore
                            </button>
                        </div>
                      ` : `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">Aree di Valore</h3>
                                    ${createCopyButton(appData.valueAreas)}
                                </div>
                                <div class="prose prose-sm max-w-none p-4 bg-gray-50 rounded border min-h-[300px] whitespace-pre-wrap">${appData.valueAreas}</div>
                            </div>
                            <button onclick="generateValueAreas()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                Rigenera Aree
                            </button>
                        </div>
                      `
                    }
                </div>
            `;
        }

        function renderStep4() {
            const onePagerData = parseOnePagerContent(appData.onePager);
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 4: One-Pager & Email di Contatto</h2>

                    ${isGenerating ? renderGeneratingPlaceholder("Generazione One-Pager in corso...") : 
                      !appData.onePager ? `
                        <div class="text-center py-12">
                            <i data-lucide="file-question" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Crea un documento di sintesi strategica per il primo contatto</p>
                            <button onclick="generateOnePager()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">
                                <i data-lucide="file-question" class="w-5 h-5 mr-2"></i>Genera One-Pager
                            </button>
                        </div>
                      ` : `
                        <div class="space-y-6">
                            <!-- One-Pager Visuale -->
                            <div class="bg-white p-8 rounded-lg shadow-lg border">
                                <h1 class="text-2xl font-bold text-center text-gray-900 mb-8">${onePagerData.title || 'One-Pager Strategico'}</h1>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200 min-h-[150px]">
                                        <h3 class="font-bold text-blue-900 mb-3">📊 Comprensione Business</h3>
                                        <p class="text-sm text-gray-700">${onePagerData.businessUnderstanding || 'In elaborazione...'}</p>
                                    </div>
                                    <div class="bg-red-50 p-6 rounded-lg border-2 border-red-200 min-h-[150px]">
                                        <h3 class="font-bold text-red-900 mb-3">⚡ Sfide Principali</h3>
                                        <div class="text-sm text-gray-700 space-y-1">
                                            ${onePagerData.challenges.length > 0 ? 
                                                onePagerData.challenges.map(c => `<div>• ${c}</div>`).join('') : 
                                                '<div class="italic text-gray-500">In elaborazione...</div>'
                                            }
                                        </div>
                                    </div>
                                    <div class="bg-green-50 p-6 rounded-lg border-2 border-green-200 min-h-[150px]">
                                        <h3 class="font-bold text-green-900 mb-3">💡 Proposta di Valore</h3>
                                        <p class="text-sm text-gray-700">${onePagerData.valueProposition || 'In elaborazione...'}</p>
                                    </div>
                                    <div class="bg-purple-50 p-6 rounded-lg border-2 border-purple-200 min-h-[150px]">
                                        <h3 class="font-bold text-purple-900 mb-3">🎯 Perché Var Group</h3>
                                        <div class="text-sm text-gray-700 space-y-1">
                                            ${onePagerData.whyUs.length > 0 ? 
                                                onePagerData.whyUs.map(w => `<div>• ${w}</div>`).join('') : 
                                                '<div class="italic text-gray-500">In elaborazione...</div>'
                                            }
                                        </div>
                                    </div>
                                    <div class="col-span-2 bg-indigo-100 p-6 rounded-lg border-2 border-indigo-300">
                                        <h3 class="font-bold text-indigo-900 mb-3 text-center">📅 Agenda Proposta</h3>
                                        <div class="text-sm text-gray-700 space-y-1">
                                            ${onePagerData.agenda.length > 0 ? 
                                                onePagerData.agenda.map(a => `<div>${a}</div>`).join('') : 
                                                '<div class="italic text-gray-500">In elaborazione...</div>'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 text-center text-sm text-gray-500">
                                    Preparato per: ${appData.companyName} | Data: ${new Date().toLocaleDateString('it-IT')}
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">Azioni</h3>
                                <div class="flex gap-2">
                                    ${createCopyButton(appData.onePager, 'Copia One-Pager')}
                                    <button onclick="generateOnePager()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                        Rigenera
                                    </button>
                                </div>
                            </div>

                            ${appData.onePager ? `
                                <div class="mt-8 pt-6 border-t">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Email di Follow-up</h3>
                                    ${!appData.contactEmail ? `
                                        <div class="text-center py-6">
                                            <button onclick="generateEmail()" class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                                                <i data-lucide="mail" class="w-5 h-5 mr-2"></i>Genera Email con One-Pager
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="bg-white p-4 rounded-lg border">
                                            <div class="flex justify-between items-center mb-2">
                                                <h4 class="font-semibold text-gray-700">Email Generata</h4>
                                                ${createCopyButton(appData.contactEmail, 'Copia Email')}
                                            </div>
                                            <div class="p-4 bg-gray-50 rounded border max-h-96 overflow-y-auto">
                                                <pre class="whitespace-pre-wrap text-sm font-sans">${appData.contactEmail}</pre>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                        </div>
                      `
                    }
                </div>
            `;
        }

        function renderStep5() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 5: Domande Discovery (SPICED)</h2>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" id="challengerMode" ${appData.challengerMode ? 'checked' : ''} 
                                       onchange="updateField('challengerMode', this.checked)"
                                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" />
                                <label for="challengerMode" class="ml-3 font-semibold text-blue-900">Modalità Challenger Sale</label>
                            </div>
                            <div class="text-xs text-blue-700 bg-blue-100 px-2 py-1 rounded">
                                ${appData.challengerMode ? 'ATTIVA' : 'STANDARD'}
                            </div>
                        </div>
                        <p class="text-sm text-blue-700 mt-2">
                            ${appData.challengerMode 
                                ? 'Genera domande provocatorie che sfidano lo status quo'
                                : 'Genera domande SPICED tradizionali e consultative'
                            }
                        </p>
                    </div>

                    ${isGenerating ? renderGeneratingPlaceholder("Generazione domande discovery...") : 
                      !appData.discoveryQuestions ? `
                        <div class="text-center py-12">
                            <i data-lucide="target" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Genera domande strategiche per guidare la conversazione</p>
                            <button onclick="generateDiscoveryQuestions()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">
                                <i data-lucide="target" class="w-5 h-5 mr-2"></i>Genera Domande ${appData.challengerMode ? 'Challenger' : 'SPICED'}
                            </button>
                        </div>
                      ` : `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">Domande Discovery</h3>
                                    ${createCopyButton(appData.discoveryQuestions)}
                                </div>
                                <div class="prose prose-sm max-w-none p-4 bg-gray-50 rounded border min-h-[300px] whitespace-pre-wrap">${appData.discoveryQuestions}</div>
                            </div>
                            <button onclick="generateDiscoveryQuestions()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                Rigenera Domande
                            </button>
                        </div>
                      `
                    }
                </div>
            `;
        }

        function renderStep6() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Step 6: Briefing Finale</h2>
                    
                    ${isGenerating ? renderGeneratingPlaceholder("Generazione briefing finale...") : 
                      !appData.finalBriefing ? `
                        <div class="text-center py-12">
                            <i data-lucide="briefcase" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 mb-6">Sintetizza tutto il lavoro in un briefing strategico finale</p>
                            <button onclick="generateFinalBriefing()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">
                                <i data-lucide="briefcase" class="w-5 h-5 mr-2"></i>Genera Briefing
                            </button>
                        </div>
                      ` : `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">Briefing Strategico</h3>
                                    ${createCopyButton(appData.finalBriefing)}
                                </div>
                                <div class="prose prose-sm max-w-none p-4 bg-gray-50 rounded border min-h-[300px] whitespace-pre-wrap">${appData.finalBriefing}</div>
                            </div>
                            <button onclick="generateFinalBriefing()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                Rigenera Briefing
                            </button>
                            
                            ${appData.finalBriefing ? `
                                <div class="mt-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                                    <h3 class="text-lg font-semibold text-green-900 mb-2">✅ Preparazione Completata!</h3>
                                    <p class="text-green-700 mb-4">Hai completato tutti gli step. Visualizza il riepilogo completo.</p>
                                    <button onclick="showSummary()" class="inline-flex items-center px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                        Riepilogo Completo <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                      `
                    }
                </div>
            `;
        }

        function renderSummary() {
            const sections = [
                { title: "C-SWOT", content: appData.cswotAnalysis, icon: "target" },
                { title: "Aree di Valore", content: appData.valueAreas, icon: "users" },
                { title: "One-Pager", content: appData.onePager, icon: "file-question" },
                { title: "Domande Discovery", content: appData.discoveryQuestions, icon: "target" },
                { title: "Briefing Finale", content: appData.finalBriefing, icon: "briefcase" },
                { title: "Email di Contatto", content: appData.contactEmail, icon: "mail" }
            ];

            return `
                <div class="space-y-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">🎯 Riepilogo Preparazione Incontro</h2>
                        <p class="text-gray-600 mb-8">Preparazione completa per l'incontro con <strong>${appData.companyName || '[Cliente]'}</strong></p>
                    </div>
                    
                    <div class="grid gap-6">
                        ${sections.map(section => `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 p-4 flex justify-between items-center border-b">
                                    <div class="flex items-center">
                                        <i data-lucide="${section.icon}" class="w-6 h-6 text-indigo-600 mr-3"></i>
                                        <h3 class="text-xl font-semibold text-gray-800">${section.title}</h3>
                                    </div>
                                    ${section.content ? createCopyButton(section.content, 'Copia') : ''}
                                </div>
                                <div class="p-6 bg-white">
                                    ${section.content ? 
                                        `<div class="prose prose-sm max-w-none whitespace-pre-wrap">${section.content}</div>` : 
                                        `<div class="text-gray-400 italic">Contenuto non generato</div>`
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-center pt-6">
                        <button onclick="currentStep = 0; renderCurrentStep(); updateStepIndicator(); updateNavigation();" 
                                class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                            Nuova Preparazione
                        </button>
                    </div>
                </div>
            `;
        }

        // AI Generation Functions
        async function generateResearchPrompt() {
            if (!canGeneratePrompt()) return;

            try {
                isGenerating = true;
                document.getElementById('generatePromptBtnText').textContent = 'Generazione...';
                document.getElementById('generatePromptBtn').disabled = true;

                const prompt = `Agisci come esperto consulente strategico di Var Group per la preparazione di ricerche pre-vendita.

La tua conoscenza di base su Var Group:
${VAR_GROUP_CONTEXT}

DATI FORNITI:
- Azienda Prospect: ${appData.preResearch.prospectName}
- Contatto: ${appData.preResearch.contactPerson || "Non specificato"}
- Aree Interesse: ${appData.preResearch.areasOfInterest || "Non specificate"}
- Nostra Offerta: ${appData.preResearch.ourCompanyInfo.content}

COMPITO: Crea un prompt di ricerca ultra-specifico per ${appData.preResearch.prospectName} che:
1. Sia ottimizzato per strumenti di ricerca avanzata (Deep Research)
2. Includa query specifiche e parole chiave mirate
3. Colleghi la ricerca ai potenziali punti di valore Var Group
4. Guidi verso insight azionabili per l'analisi C-SWOT

Fornisci ESCLUSIVAMENTE il prompt di ricerca, dettagliato e pronto all'uso.`;

                generatedPrompt = await generateContent(prompt);
                
                document.getElementById('promptContent').textContent = generatedPrompt;
                document.getElementById('promptCopyBtn').innerHTML = createCopyButton(generatedPrompt, 'Copia Prompt');
                document.getElementById('promptResult').classList.remove('hidden');
                
                lucide.createIcons();

            } catch (error) {
                console.error("Errore generazione prompt:", error);
                alert("Errore durante la generazione del prompt: " + error.message);
            } finally {
                isGenerating = false;
                document.getElementById('generatePromptBtnText').textContent = 'Rigenera Prompt';
                document.getElementById('generatePromptBtn').disabled = false;
            }
        }

        function updatePromptButton() {
            const btn = document.getElementById('generatePromptBtn');
            if (btn) {
                btn.disabled = !canGeneratePrompt();
            }
        }

        // Optimized Var Group Context (abbreviated for speed)
        const VAR_GROUP_CONTEXT_SHORT = `
# Var Group - Digital Soul Company
Sistema di integrazione leader in Italia, parte del Gruppo SeSa quotato. 4.297 dipendenti, 882M€ fatturato 2025.

## Business Unit Principali:
- **7Circle**: Cloud, servitizzazione, IoT
- **Data Science**: 180 risorse, 40+ Data Scientist, AI/ML
- **Yarix**: Cybersecurity, 230 specialisti, 3 SOC
- **Var Industries**: Digital Engineering, 13 nazioni
- **Enterprise Platform**: SAP/Microsoft, 500+ consulenti
- **Digital Experience (Ubics)**: Web, app, e-commerce
- **iSquared**: Nuova iniziativa AI strategica

## Partnership: Microsoft Gold, SAP Platinum, AWS, IBM, HPE, Cisco
## Settori: Manufacturing, Fashion, Retail, Food, Pharma, Finance, PA
`;

        async function generateCSWOT() {
    if (!appData.companyName.trim()) {
        showErrorModal("Nome azienda cliente richiesto per generare l'analisi C-SWOT");
        return;
    }

    const prompt = `Agisci come analista di business intelligence d'elite di Var Group.

${VAR_GROUP_CONTEXT}

CONTESTO SPECIFICO:
- Azienda Cliente: ${appData.companyName}
- Servizio: ${appData.serviceName || "Soluzioni digitali"}
- Info Cliente: ${appData.clientFiles.content || "Informazioni limitate disponibili"}
- Info Nostra: ${appData.internalFiles.content || "Portfolio standard Var Group"}

Genera un'analisi C-SWOT completa e dettagliata. Per ogni punto descrivi:
1. L'elemento specifico
2. L'IMPATTO sul business del cliente
3. Le IMPLICAZIONI per la strategia Var Group

Struttura richiesta:
## PUNTI DI FORZA (Customer Strengths)
[Almeno 3 punti con dettagli]

## PUNTI DI DEBOLEZZA (Customer Weaknesses) 
[Almeno 3 punti con dettagli]

## OPPORTUNITÀ (Customer Opportunities)
[Almeno 3 punti con dettagli]

## MINACCE (Customer Threats)
[Almeno 3 punti con dettagli]

Sii specifico e orientato all'azione. Usa formato Markdown.`;

    try {
        isGenerating = true;
        renderCurrentStep();
        
        console.log("Iniziando generazione C-SWOT per:", appData.companyName);
        
        appData.cswotAnalysis = await generateContent(prompt);
        
        console.log("C-SWOT generata con successo");
        renderCurrentStep();
        updateNavigation();
        
    } catch (error) {
        console.error("Errore C-SWOT:", error);
        showErrorModal(`Errore durante la generazione dell'analisi C-SWOT: ${error.message}`);
        isGenerating = false;
        renderCurrentStep();
    } finally {
        isGenerating = false;
    }
}

        async function generateValueAreas() {
            // Also optimized for speed
            const prompt = `Consulente strategico Var Group.

CONTESTO:
${VAR_GROUP_CONTEXT_SHORT}

C-SWOT: ${appData.cswotAnalysis.substring(0, 1500)}${appData.cswotAnalysis.length > 1500 ? '...' : ''}

Identifica 3 Aree Valore per ${appData.companyName}:

## Area 1: [Nome Area]
**Problema**: [mal di pancia specifico]
**Soluzione Var Group**: [BU specifica + approccio con ${appData.serviceName}]  
**Target**: [ruolo GDEUA]
**Benefici**: 2 quantitativi, 2 qualitativi

## Area 2: [Nome Area]
[stessa struttura]

## Area 3: [Nome Area]  
[stessa struttura]

Conciso e specifico.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.valueAreas = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Aree Valore:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateOnePager() {
            // Streamlined for speed
            const prompt = `One Pager strategico Var Group.

Cliente: ${appData.companyName}
Servizio: ${appData.serviceName}
C-SWOT: ${appData.cswotAnalysis.substring(0, 800)}
Aree Valore: ${appData.valueAreas.substring(0, 800)}

Var Group: Leader system integration, BU specializzate (Data Science AI, Yarix Security, Industries Engineering, etc), partnership Microsoft/SAP/AWS.

<sezione_titolo>
[Titolo impattante per ${appData.companyName}]
</sezione_titolo>

<sezione_business>
[2-3 frasi comprensione settore cliente]
</sezione_business>

<sezione_sfide>
[Top 3 sfide cliente, una per riga]
</sezione_sfide>

<sezione_valore>
[Come ${appData.serviceName} aiuta, 2-3 frasi benefici]
</sezione_valore>

<sezione_perchenoi>
[3 differenziatori Var Group, uno per riga]
</sezione_perchenoi>

<sezione_agenda>
[3-4 punti agenda meeting]
</sezione_agenda>

Solo XML format.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.onePager = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore One-Pager:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateEmail() {
            // Simplified email generation
            const prompt = `Email B2B Var Group per ${appData.companyName}.

One-Pager da incorporare: ${appData.onePager.substring(0, 1200)}

Regole:
- Oggetto incuriosente
- Intro personalizzata 2 frasi  
- "--- SINTESI STRATEGICA ${appData.companyName.toUpperCase()} ---"
- Traduci XML in testo leggibile (NO tag)
- "--- FINE SINTESI ---"
- CTA per incontro

Inizia con "OGGETTO: [oggetto qui]"`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.contactEmail = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Email:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateDiscoveryQuestions() {
            // Faster discovery generation
            const challengerNote = appData.challengerMode ? 'CHALLENGER MODE: Domande provocatorie che sfidano assunzioni.' : '';
            
            const prompt = `Sales Coach Var Group. ${challengerNote}

Cliente: ${appData.companyName}
C-SWOT: ${appData.cswotAnalysis.substring(0, 1000)}
Aree Valore: ${appData.valueAreas.substring(0, 1000)}

15 domande SPICED${appData.challengerMode ? ' provocatorie' : ''}:

## S - Situation (3)
[domande contesto${appData.challengerMode ? ' + sfida assunzioni' : ''}]

## P - Pain (3)  
[domande difficoltà${appData.challengerMode ? ' + problemi nascosti' : ''}]

## I - Impact (3)
[domande impatto economico${appData.challengerMode ? ' + costo inazione' : ''}]

## CE - Critical Event (3)
[domande urgenza/scadenze]

## D - Decision (3)
[domande processo decisionale GDEUA]

Contestualizzate su ${appData.companyName}.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.discoveryQuestions = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Discovery:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateFinalBriefing() {
            // Quick briefing generation
            const prompt = `Briefing veloce Sales Director per ${appData.companyName}.

Dati: C-SWOT + Aree Valore + One-Pager (${appData.cswotAnalysis.substring(0, 600)} | ${appData.valueAreas.substring(0, 600)})

MAX 150 parole:

**OBIETTIVO**: [1 frase misurabile]
**LEVA PRINCIPALE**: [area valore top]  
**OBIEZIONE**: [da C-SWOT + come gestire]
**AZIONE CHIUSURA**: [next step concreto]
**3 PUNTI CHIAVE**: 
- [punto 1]
- [punto 2] 
- [punto 3]

Chirurgico e actionable.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.finalBriefing = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } finally {
                isGenerating = false;
            }
        }

        function parseOnePagerContent(content) {
            const data = { title: '', businessUnderstanding: '', challenges: [], valueProposition: '', whyUs: [], agenda: [] };
            if (!content) return data;
            
            const extractSection = (tag) => {
                const match = content.match(new RegExp(`<${tag}>([\\s\\S]*?)<\\/${tag}>`, 'i'));
                return match ? match[1].trim() : '';
            };
            
            data.title = extractSection('sezione_titolo');
            data.businessUnderstanding = extractSection('sezione_business');
            data.valueProposition = extractSection('sezione_valore');
            data.challenges = extractSection('sezione_sfide').split('\n').map(l => l.trim().replace(/^[•\-\*▪▸]\s*/, '')).filter(Boolean);
            data.whyUs = extractSection('sezione_perchenoi').split('\n').map(l => l.trim().replace(/^[•\-\*▪▸]\s*/, '')).filter(Boolean);
            data.agenda = extractSection('sezione_agenda').split('\n').filter(Boolean);
            
            return data;
        }

        async function generateOnePager() {
            const prompt = `Agisci come consulente strategico di Var Group.

${VAR_GROUP_CONTEXT}

Genera contenuto per One Pager strategico basato su:
- Cliente: ${appData.companyName}
- Servizio: ${appData.serviceName}  
- C-SWOT: ${appData.cswotAnalysis}
- Aree Valore: ${appData.valueAreas}

STRUTTURA RICHIESTA (usa ESATTAMENTE questi tag XML):

<sezione_titolo>
[Titolo impattante focalizzato sul cliente]
</sezione_titolo>

<sezione_business>
[3-4 frasi che dimostrano comprensione del settore]
</sezione_business>

<sezione_sfide>
[3 sfide più rilevanti, una per riga]
</sezione_sfide>

<sezione_valore>
[Come ${appData.serviceName} può aiutare, 3-4 frasi sui benefici]
</sezione_valore>

<sezione_perchenoi>
[3 elementi differenzianti Var Group, uno per riga]
</sezione_perchenoi>

<sezione_agenda>
[3-4 punti agenda incontro, specifici per il cliente]
</sezione_agenda>

Fornisci ESCLUSIVAMENTE l'output nel formato XML richiesto.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.onePager = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore One-Pager:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateEmail() {
            const prompt = `Agisci come esperto comunicazione B2B per Var Group.

FILOSOFIA: Il nostro ruolo è "aiutare a comprare", non vendere. L'email deve facilitare il processo d'acquisto del cliente.

CONTESTO:
- Azienda Target: ${appData.companyName}
- Soluzione: ${appData.serviceName}
- One-Pager: ${appData.onePager}

ISTRUZIONI EMAIL:
1. OGGETTO: Professionale e incuriosente per ${appData.companyName}
2. CORPO:
   - Introduzione personalizzata (2-3 frasi)
   - "--- SINTESI STRATEGICA PER ${appData.companyName.toUpperCase()} ---"
   - Traduci il contenuto XML del One-Pager in formato leggibile (NO tag XML)
   - "--- FINE SINTESI ---" 
   - Call to action per un incontro

REGOLE:
- Zero allegati, email auto-contenuta
- Leggibilità perfetta del One-Pager incorporato
- Valore immediato percepibile

OUTPUT: Solo il testo email, inizia con "OGGETTO: [oggetto]"`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.contactEmail = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Email:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateDiscoveryQuestions() {
            const challengerSection = appData.challengerMode ? `
MODALITÀ CHALLENGER ATTIVA:
Applica principi Challenger Sale con approccio basato sui fatti. Sfida le assunzioni del cliente usando logica e insight dai documenti forniti.

REGOLE ANTI-ALLUCINAZIONE:
1. ZERO dati inventati (statistiche, percentuali, competitor)
2. Usa formulazioni ipotetiche: "Spesso osserviamo che..." invece di "Il 70% delle aziende..."
3. Basa domande sulla logica interna della C-SWOT

OBIETTIVO: Far dire al cliente "Non ci avevo mai pensato così"` : '';

            const prompt = `Agisci come Sales Coach esperto del "Var Group Way of Selling".

${VAR_GROUP_CONTEXT}

FILOSOFIA: I venditori medi parlano, i professionisti domandano. Le domande servono a far "scoprire" il valore al cliente.

CONTESTO:
- Cliente: ${appData.companyName}
- C-SWOT: ${appData.cswotAnalysis}
- Aree Valore: ${appData.valueAreas}

${challengerSection}

Genera 15 domande ${appData.challengerMode ? 'provocatorie e insight-driven' : 'aperte e potenti'} per il primo incontro, organizzate per framework SPICED:

**S - Situation:** (3 domande contesto attuale${appData.challengerMode ? ' e sfida assunzioni' : ''})
**P - Pain:** (3 domande difficoltà${appData.challengerMode ? ' e problemi nascosti' : ''})
**I - Impact:** (3 domande impatto economico${appData.challengerMode ? ' e costo inazione' : ''})
**CE - Critical Event:** (3 domande eventi/scadenze urgenti)
**D - Decision:** (3 domande processo decisionale GDEUA)

Domande ultra-contestualizzate su ${appData.companyName} e Aree Valore identificate.

Formato Markdown esclusivamente.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.discoveryQuestions = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Discovery:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        async function generateFinalBriefing() {
            const prompt = `Agisci come Sales Director di Var Group. Sintetizza l'intero percorso per l'incontro con ${appData.companyName} in un briefing ultra-conciso.

${VAR_GROUP_CONTEXT}

DATI:
- C-SWOT: ${appData.cswotAnalysis}
- Aree Valore: ${appData.valueAreas}
- One-Pager: ${appData.onePager}

BRIEFING (MAX 200 parole):
1. **OBIETTIVO PRIMARIO** (1 frase misurabile)
2. **LEVA PRINCIPALE** (Area valore più forte)
3. **OBIEZIONE DA ANTICIPARE** (Basata su C-SWOT + come gestirla)
4. **AZIONE CHIAVE CHIUSURA** (Prossimo passo concreto)
5. **3 PUNTI CHIAVE** (Bullets ultra-sintetici)

Sii chirurgico e orientato all'azione. Formato Markdown.`;

            try {
                isGenerating = true;
                renderCurrentStep();
                
                appData.finalBriefing = await generateContent(prompt);
                
                renderCurrentStep();
                updateNavigation();
            } catch (error) {
                console.error("Errore Briefing:", error);
                alert("Errore durante la generazione: " + error.message);
            } finally {
                isGenerating = false;
            }
        }

        // Navigation Functions
        function proceedToStep1() {
            appData.companyName = appData.preResearch.prospectName;
            appData.internalFiles = {
                content: appData.preResearch.ourCompanyInfo.content,
                names: appData.preResearch.ourCompanyInfo.names
            };
            nextStep();
        }

        function nextStep() {
            if (currentStep < 6 && (canProceed() || currentStep === 0)) {
                currentStep++;
                renderCurrentStep();
                updateStepIndicator();
                updateNavigation();
                window.scrollTo(0, 0);
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderCurrentStep();
                updateStepIndicator();
                updateNavigation();
                window.scrollTo(0, 0);
            }
        }

        function showSummary() {
            currentStep = 7;
            renderCurrentStep();
            updateNavigation();
            window.scrollTo(0, 0);
        }

        function renderCurrentStep() {
            const stepContent = document.getElementById('stepContent');
            
            let content = '';
            switch (currentStep) {
                case 0: content = renderStep0(); break;
                case 1: content = renderStep1(); break;
                case 2: content = renderStep2(); break;
                case 3: content = renderStep3(); break;
                case 4: content = renderStep4(); break;
                case 5: content = renderStep5(); break;
                case 6: content = renderStep6(); break;
                case 7: content = renderSummary(); break;
                default: content = renderStep0();
            }
            
            stepContent.innerHTML = content;
            lucide.createIcons();
        }

        // Safe Lucide initialization
        function initLucide() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            } else {
                console.warn('Lucide not loaded yet, retrying...');
                setTimeout(initLucide, 100);
            }
        }

        // Initialize App
        function initApp() {
            // Set up event handlers
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('summaryBtn').addEventListener('click', showSummary);
            
            // Close modal when clicking outside
            document.getElementById('copyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
            
            // Initial render
            renderCurrentStep();
            updateStepIndicator();
            updateNavigation();
            
            // Initialize Lucide icons safely
            initLucide();
        }

        // Override renderCurrentStep to always init icons after content change
        const originalRenderCurrentStep = renderCurrentStep;
        renderCurrentStep = function() {
            originalRenderCurrentStep();
            initLucide();
        }

        const originalUpdateStepIndicator = updateStepIndicator;
        updateStepIndicator = function() {
            originalUpdateStepIndicator();
            initLucide();
        }

        // Global functions for inline event handlers
        window.updateField = updateField;
        window.updateFileContent = updateFileContent;
        window.updatePreResearchField = updatePreResearchField;
        window.handleFileUpload = handleFileUpload;
        window.handlePreResearchFileUpload = handlePreResearchFileUpload;
        window.copyToClipboard = copyToClipboard;
        window.generateResearchPrompt = generateResearchPrompt;
        window.updatePromptButton = updatePromptButton;
        window.generateCSWOT = generateCSWOT;
        window.generateValueAreas = generateValueAreas;
        window.generateOnePager = generateOnePager;
        window.generateEmail = generateEmail;
        window.generateDiscoveryQuestions = generateDiscoveryQuestions;
        window.generateFinalBriefing = generateFinalBriefing;
        window.proceedToStep1 = proceedToStep1;
        window.showSummary = showSummary;
        
        // Enhanced initialization with library loading detection
        function waitForLibrariesAndInit() {
            // Check if all required libraries are loaded
            const requiredLibraries = [
                { name: 'lucide', check: () => typeof lucide !== 'undefined' },
                { name: 'mammoth', check: () => typeof mammoth !== 'undefined' },
                { name: 'pdfjsLib', check: () => typeof pdfjsLib !== 'undefined' }
            ];
            
            let allLoaded = true;
            requiredLibraries.forEach(lib => {
                if (!lib.check()) {
                    allLoaded = false;
                    console.log(`Waiting for ${lib.name} to load...`);
                }
            });
            
            if (allLoaded) {
                // Initialize PDF.js worker
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
                }
                // Global functions for inline event handlers
window.showErrorModal = showErrorModal;
window.closeErrorModal = closeErrorModal;
                initApp();
            } else {
                setTimeout(waitForLibrariesAndInit, 100);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForLibrariesAndInit);
        } else {
            waitForLibrariesAndInit();
        }
    </script>
</body>
</html>
